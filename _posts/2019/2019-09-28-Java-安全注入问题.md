---
layout: post
title: JAVA 安全注入问题
category: java
tags: [java,安全]
---

# JAVA 安全注入问题 #

## 注入的攻击 ##

### SQL 注入 ###

    Select * from use_info where username = “input_usr_name” and password = “input_pwd”

    如果我输入的 input_pwd 是类似下面的文本

    “ or “”=”

### 操作系统命令注入 ###

利用 Runtime.exec(command) 执行操作的时候，被串改。

    command = 'ls -la filename' 被串改为 command = 'ls -la filename;rf -rf /*'
    
是否有一种删库跑路的感觉？

![avatar](http://5b0988e595225.cdn.sohucs.com/images/20170914/977f8f27dedf4f2797893f94a0bae83d.jpeg)   

### XML 注入攻击 ###

Java 核心类库提供了全面的 XML 处理、转换等各种 API，而 XML 自身是可以包含动态内容的，例如 XPATH，如果使用不当，可能导致访问恶意内容。

### 其他 ###

还有类似 LDAP 等允许动态内容的协议，都是可能利用特定命令，构造注入式攻击的，包括 XSS（Cross-site Scripting）攻击，虽然并不和 Java 直接相关，但也可能在 JSP 等动态页面中发生。

## 防止注入攻击 ##

1. 在数据输入阶段，填补期望输入和可能输入之间的鸿沟。可以进行输入校验，限定什么类型的输入是合法的，例如，不允许输入标点符号等特殊字符，或者特定结构的输入。

2. 在 Java 应用进行数据库访问时，如果不用完全动态的 SQL，而是利用 PreparedStatement，可以有效防范 SQL 注入。不管是 SQL 注入，还是 OS 命令注入，程序利用字符串拼接生成运行逻辑都是个可能的风险点！

3. 在数据库层面，如果对查询、修改等权限进行了合理限制，就可以在一定程度上避免被注入删除等高破坏性的代码。

总之，在安全领域，有一句准则：安全倾向于 “明显没有漏洞”，而不是“没有明显漏洞”。所以，为了更加安全可靠的服务，我们最好是采取整体性的安全设计和综合性的防范手段，不能心存侥幸。

一个比较普适的建议是，尽量使用较新版本的 JDK，并使用推荐的安全机制和标准。如果你有看过 JDK release notes，，你会发现 JDK 更新会修复已知的安全漏洞，并且会对安全机制等进行增强。但现实情况是，相当一部分应用还在使用很古老的不安全版本 JDK 进行开发，并且很多信息处理的也很随意，或者通过明文传输、存储，这些都存在暴露安全隐患的可能。

## 安全机制 ##

### 运行时安全机制 ###

1. 在类加载过程中，进行字节码验证，以防止不合规的代码影响 JVM 运行或者载入其他恶意代码。【在tomcat里面会存在一些解压的项目，如果里面被放入一个不安全的java类，启动的时候被加载了，就可能导致破坏性。】

2. 类加载器本身也可以对代码之间进行隔离，例如，应用无法获取启动类加载器（Bootstrap Class-Loader）对象实例，不同的类加载器也可以起到容器的作用，隔离模块之间不必要的可见性等。目前，Java Applet、RMI 等特性已经或逐渐退出历史舞台，类加载等机制总体上反倒在不断简化。

3. 利用 SecurityManger 机制和相关的组件，限制代码的运行时行为能力，其中，你可以定制 policy 文件和各种粒度的权限定义，限制代码的作用域和权限，例如对文件系统的操作权限，或者监听某个网络端口的权限等。Java 的安全模型是以代码为中心的，贯穿了从类加载，如 URLClassLoader 加载网络上的 Java 类等，到应用程序运行时权限检查等全过程。

4. 从原则上来说，Java 的 GC 等资源回收管理机制，都可以看作是运行时安全的一部分，如果相应机制失效，就会导致 JVM 出现 OOM 等错误，可看作是另类的拒绝服务。

### Java 提供的安全框架 API ###
    
1. 加密、解密 API

2. 授权、鉴权 API。

3. 安全通信相关的类库，比如基本 HTTPS 通信协议相关标准实现，如 [TLS 1.3](http://openjdk.java.net/jeps/332)；或者附属的类似证书撤销状态判断 [OSCP](https://en.wikipedia.org/wiki/Online_Certificate_Status_Protocol) 等协议实现。   

### JDK 集成的各种安全工具 ###

1. keytools , 这是个强大的工具，可以管理安全场景中不可或缺的秘钥、证书等，并且可以管理 Java 程序使用的 keystore 文件。【在服务之间调用，证书可以保证一定的安全。】

2. jarsigner, 用于对 jar 文件进行签名或者验证。 【防止有人破坏jar文件，引入未签名class】
              
在应用实践中，如果对安全要求非常高，建议打开 SecurityManager ,-Djava.security.manager

请注意其开销，通常只要开启 SecurityManager，就会导致 10% ~ 15% 的性能下降，在 JDK 9 以后，这个开销有所改善。【近期工作发现这个使用量特别多。】

## 了解攻击 ##

[MITM攻击](https://baike.baidu.com/item/%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB/1739730?fromtitle=MITM%E6%94%BB%E5%87%BB&fromid=15637385&fr=aladdin)

[DOS攻击](https://baike.baidu.com/item/dos%E6%94%BB%E5%87%BB/3792374?fr=aladdin)  

## 总结 ##

1. 提高代码质量

2. 安全设计更全面

3. 保证加载的类是你预期加载的。 


参考： 极客时间/杨晓峰/你了解Java应用开发中的注入攻击吗？